<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>–ï–† –¢–û–°–¢–ò–ö // –ê–õ–ú–ê–¢–´</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-user-select:none;}
body{background:#000;overflow:hidden;font-family:'Courier New',monospace;touch-action:none;}
canvas{display:block;position:fixed;top:0;left:0;}
#ui{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;}
/* HUD */
#hud{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.panel{background:rgba(0,0,0,0.78);border:1px solid rgba(0,210,210,0.35);backdrop-filter:blur(5px);padding:8px 12px;border-radius:5px;}
#p-left .title{font-size:15px;font-weight:bold;letter-spacing:5px;color:#00ffff;text-shadow:0 0 10px #00d4d4;}
#p-left .sub{font-size:9px;color:#00d4d455;margin-top:2px;letter-spacing:1px;}
#p-left .status{font-size:10px;color:#00d4d4cc;margin-top:4px;}
#p-right{min-width:130px;text-align:right;}
#wanted-row{display:flex;gap:2px;justify-content:flex-end;margin-bottom:5px;}
#wanted-row span{font-size:15px;}
.bar-row{display:flex;align-items:center;gap:6px;margin-top:4px;}
.bar-lbl{font-size:8px;color:#ffffff44;width:24px;text-align:right;letter-spacing:1px;}
.bar-bg{flex:1;height:5px;background:#111;border-radius:3px;overflow:hidden;}
.bar-fill{height:100%;border-radius:3px;transition:width .2s;}
#hp-bar{background:linear-gradient(90deg,#ff2222,#ff7722);}
#armor-bar{background:linear-gradient(90deg,#2255ff,#44ccff);}
#p-weapon{font-size:11px;color:#00ffff;margin-top:5px;letter-spacing:1px;}
#p-ammo{font-size:9px;color:#ffffff44;}
#minimap{position:absolute;top:10px;left:50%;transform:translateX(-50%);border:1px solid rgba(0,212,212,0.3);border-radius:3px;}
#notify{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-size:18px;font-weight:bold;letter-spacing:4px;opacity:0;transition:opacity .25s;pointer-events:none;text-align:center;}
#clog{position:absolute;top:160px;left:10px;font-size:9px;line-height:1.9;color:#ff9988;pointer-events:none;max-width:200px;}
#speedo{position:absolute;bottom:155px;right:14px;text-align:right;pointer-events:none;}
#speedo .num{font-size:32px;font-weight:bold;color:#00ffff;text-shadow:0 0 10px #00d4d4;line-height:1;}
#speedo .lbl{font-size:8px;color:#555;letter-spacing:4px;}
#keyhint{position:absolute;bottom:155px;left:12px;color:#ffffff18;font-size:9px;line-height:2.1;}
/* CONTROLS */
#ctrl{position:absolute;bottom:0;left:0;width:100%;height:175px;pointer-events:none;display:flex;align-items:flex-end;justify-content:space-between;padding:0 14px 18px;gap:8px;}
#joy-zone{width:118px;height:118px;pointer-events:all;touch-action:none;flex-shrink:0;}
#joy-base{width:118px;height:118px;border-radius:50%;background:rgba(0,212,212,0.04);border:2px solid rgba(0,212,212,0.2);position:relative;display:flex;align-items:center;justify-content:center;}
.ja{position:absolute;color:rgba(0,212,212,0.25);font-size:10px;font-weight:bold;}
.ja.u{top:5px;left:50%;transform:translateX(-50%);}
.ja.d{bottom:5px;left:50%;transform:translateX(-50%);}
.ja.l{left:5px;top:50%;transform:translateY(-50%);}
.ja.r{right:5px;top:50%;transform:translateY(-50%);}
#joy-thumb{width:44px;height:44px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#00ffffdd,#00a8a8aa);border:2px solid #00d4d4bb;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);box-shadow:0 0 12px #00d4d455;}
#ctx-btns{flex:1;display:flex;flex-direction:column;gap:7px;align-items:center;pointer-events:all;}
#drive-panel{display:none;flex-direction:column;gap:5px;align-items:center;width:100%;}
#walk-panel{display:flex;flex-direction:column;gap:5px;align-items:center;width:100%;}
#act-btns{display:flex;flex-direction:column;gap:7px;align-items:flex-end;pointer-events:all;flex-shrink:0;}
.btn{border-radius:8px;border:2px solid;font-family:'Courier New',monospace;font-size:11px;font-weight:bold;letter-spacing:1px;cursor:pointer;pointer-events:all;background:rgba(0,0,0,0.78);backdrop-filter:blur(4px);-webkit-tap-highlight-color:transparent;touch-action:manipulation;display:flex;align-items:center;justify-content:center;transition:transform .07s;line-height:1.2;}
.btn:active,.btn.on{transform:scale(0.88);}
#b-gas{border-color:#44ff88;color:#44ff88;width:70px;height:42px;box-shadow:0 0 8px #44ff8820;}
#b-brk{border-color:#ff4444;color:#ff4444;width:70px;height:42px;box-shadow:0 0 8px #ff444420;}
#b-gas.on{background:#44ff8820;box-shadow:0 0 18px #44ff8866;}
#b-brk.on{background:#ff444420;box-shadow:0 0 18px #ff444466;}
#b-car{border-color:#44aaff;color:#44aaff;width:70px;height:42px;box-shadow:0 0 8px #44aaff20;}
#b-grab{border-color:#cc44ff;color:#cc44ff;width:70px;height:34px;font-size:10px;display:none;}
#b-grab.vis{display:flex;}
#b-attack{border-color:#00ffff;color:#00ffff;width:64px;height:64px;border-radius:50%;font-size:20px;box-shadow:0 0 10px #00d4d420;}
#b-attack.on{background:rgba(0,255,255,0.12);box-shadow:0 0 25px #00ffff88;}
#b-sprint{border-color:#ffd700;color:#ffd700;width:64px;height:36px;font-size:11px;box-shadow:0 0 8px #ffd70020;}
#b-sprint.on{background:rgba(255,215,0,0.12);}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui">
  <div id="hud">
    <div class="panel" id="p-left">
      <div class="title">–ï–† –¢–û–°–¢–ò–ö</div>
      <div class="sub" id="loc">–ê–õ–ú–ê–¢–´</div>
      <div class="status" id="status">–ù–ê –ù–û–ì–ê–•</div>
    </div>
    <canvas id="minimap" width="148" height="108"></canvas>
    <div class="panel" id="p-right">
      <div id="wanted-row"></div>
      <div id="p-weapon">‚úä –ö–£–õ–ê–ö–ò</div>
      <div id="p-ammo"></div>
      <div class="bar-row"><span class="bar-lbl">HP</span><div class="bar-bg"><div class="bar-fill" id="hp-bar" style="width:100%"></div></div></div>
      <div class="bar-row"><span class="bar-lbl">ARM</span><div class="bar-bg"><div class="bar-fill" id="armor-bar" style="width:0%"></div></div></div>
    </div>
  </div>
  <div id="notify"></div>
  <div id="clog"></div>
  <div id="speedo"><div class="num" id="spd">0</div><div class="lbl">–ö–ú/–ß</div></div>
  <div id="keyhint">W/A/S/D ‚Äî –î–≤–∏–∂–µ–Ω–∏–µ<br>E ‚Äî –í–æ–π—Ç–∏/–í—ã–π—Ç–∏ –∏–∑ –º–∞—à–∏–Ω—ã<br>F / –õ–ö–ú ‚Äî –ê—Ç–∞–∫–∞<br>R ‚Äî –°—Ç—Ä–µ–ª—è—Ç—å<br>G ‚Äî –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ—Ä—É–∂–∏–µ<br>Shift ‚Äî –ë–µ–≥ | –ö–æ–ª—ë—Å–∏–∫–æ ‚Äî –ó—É–º</div>
  <div id="ctrl">
    <div id="joy-zone"><div id="joy-base"><span class="ja u">‚ñ≤</span><span class="ja d">‚ñº</span><span class="ja l">‚óÄ</span><span class="ja r">‚ñ∂</span><div id="joy-thumb"></div></div></div>
    <div id="ctx-btns">
      <div id="drive-panel"><button class="btn" id="b-gas">‚¨Ü –ì–ê–ó</button><button class="btn" id="b-brk">‚¨á –¢–û–†–ú–û–ó</button></div>
      <div id="walk-panel"><button class="btn" id="b-car">üöó –ú–ê–®–ò–ù–ê</button><button class="btn" id="b-grab">‚öó –í–ó–Ø–¢–¨</button></div>
    </div>
    <div id="act-btns"><button class="btn" id="b-attack">‚öîÔ∏è</button><button class="btn" id="b-sprint">‚ö° –ë–ï–ì</button></div>
  </div>
</div>
<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ER TOSTIK PIXEL DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Extracted and isometric-adapted from the source sprite
const C = {
  HD:'#2d3561',HM:'#4a5a8a',HL:'#6b7db5',HS:'#9fb3ff',
  GD:'#ffd700',GK:'#b8860b',
  AD:'#1a4d5c',AM:'#2d7a8f',AL:'#45a8c5',AS:'#7fd8f0',
  TD:'#8b0000',TM:'#c41e3a',TL:'#e63946',
  SD:'#00a8a8',SM:'#00d4d4',SL:'#00ffff',SG:'#b0ffff',
  BL:'#8b4513',BB:'#ffd700',
  OD:'#3d2817',OM:'#5c4033',OL:'#7d5a3d',
  KD:'#8d6e63',KM:'#a1887f',KL:'#bcaaa4',
  WD:'#b0c4de',WM:'#d3e5f5',WL:'#f0f8ff',
  HG:'#daa520',HJ:'#ff0000',
  _:null
};

// 32x32 pixel idle frame ‚Äî adapted for isometric view (skewed slightly)
// Each row is an array of color keys
const IDLE1 = [
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'SL','SM',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,'SM','SL','SM','SD',0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'SM','SD',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'HS','HL',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,'HL','HS','HS','HM','HD',0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,'HL','HL','HL','HM','HM','HD','HD',0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,'GD','GD','GD','GK','GK','GD','GD',0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,'SD','KD','KM','KM','HM','HM','KM','KD','SM',0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,'SM','SL','KM','KL','HD','HD','KL','KM','SM','SL','SD',0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,'SM','SL',0,'AD','AM','AL','AM','AM','AL','AM','AD',0,'SM',0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,'SD',0,0,'AM','AL','AL','AM','AM','AL','AL','AM',0,'SD',0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,'AM','AL','GD','AL','AM','AM','AL','GD','AL','AM',0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,'AM','GD','GD','AL','AM','AM','AL','GD','GD','AM',0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,'AD','AM','AL','AM','AD','AD','AM','AL','AM','AD',0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,'BL','BL','BL','BL','BB','BB','BL','BL','BL','BL',0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,'AM','TM','TD','TM','AL','GD','GD','AL','TM','TD','TM','AM',0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,'AM','AL','TL','TM','TL','TM','TL','TL','TM','TL','TM','TL','AL','AM',0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,'AM','AL',0,'TM','TL','TM','TL','TM','TM','TL','TM','TL','TM',0,'AL','AM',0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,'KD','OD','OM',0,'TD','TM','TD','TM','TD','TD','TM','TD','TM','TD',0,'OM','OD','HG','HJ',0,0,0,0,0,0],
  [0,0,0,0,0,0,0,'OD',0,'OL',0,0,'TM','TL','TM','TL','TL','TM','TL','TM',0,0,'OL',0,'HG',0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,'OD',0,'OM',0,0,'TM','AM','AL','TM','TM','AL','AM','TM',0,0,'OM',0,'WD','WM',0,0,0,0,0,0],
  [0,0,0,0,0,0,0,'OM',0,'OL',0,0,'AM','AL','AM','TL','TL','AM','AL','AM',0,0,'OL',0,'WD','WM',0,0,0,0,0,0],
  [0,0,0,0,0,0,0,'OM',0,0,0,0,'AM','AL','AM','TL','TL','AM','AL','AM',0,0,0,0,'WM','WL',0,0,0,0,0,0],
  [0,0,0,0,0,0,0,'OL',0,0,0,0,'OD','OM','OL','TM','TM','OL','OM','OD',0,0,0,0,'WM','WD',0,0,0,0,0,0],
  [0,0,0,0,0,0,0,'OL',0,0,0,0,'OD','OM','OL','OM','OM','OL','OM','OD',0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,'OD','OM','OM','OL','OL','OM','OM','OD',0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,'OD','OD','OM','OM','OD','OD',0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
];

// Attack frame (attack1 from source)
const ATTACK1 = JSON.parse(JSON.stringify(IDLE1));
// Sword extended right in row 15
ATTACK1[15][19]='HG';ATTACK1[15][20]='HJ';ATTACK1[15][21]='HG';
ATTACK1[15][22]='WL';ATTACK1[15][23]='WM';ATTACK1[15][24]='WL';ATTACK1[15][25]='WM';ATTACK1[15][26]='WL';
ATTACK1[16][22]='WD';ATTACK1[16][23]='WD';ATTACK1[16][24]='WD';ATTACK1[16][25]='WD';ATTACK1[16][26]='WD';
ATTACK1[14][24]='SL';ATTACK1[14][25]='SM';ATTACK1[17][24]='SM';

// Walk frame 2 (right leg forward)  
const WALK2 = JSON.parse(JSON.stringify(IDLE1));
WALK2[21][16]='TL';WALK2[22][16]='TL';WALK2[23][16]='TM';WALK2[24][16]='AM';WALK2[25][16]='AM';
WALK2[26][16]='OL';WALK2[27][16]='OL';WALK2[28][15]='OM';WALK2[28][16]='OM';WALK2[28][17]='OD';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TILE=64,HT=32,MAP_W=100,MAP_H=84,RW=3;
const T_EMPTY=0,T_ROAD=1,T_CROSS=2,T_PARK=3;
const AVS=[4,12,20,28,36,44,52,60,68,76,84,92];
const STS=[4,12,20,28,36,44,52,60,68,76];
const PARKS=[
  {x:28,y:28,w:6,h:6,name:"–ü–∞—Ä–∫ –ü–∞–Ω—Ñ–∏–ª–æ–≤–∞"},
  {x:44,y:12,w:7,h:5,name:"–ü–∞—Ä–∫ –ì–æ—Ä—å–∫–æ–≥–æ"},
  {x:36,y:44,w:5,h:4,name:"–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ø–∞—Ä–∫"},
  {x:60,y:28,w:5,h:5,name:"–ü–∞—Ä–∫ 28 –ì–≤–∞—Ä–¥–µ–π—Ü–µ–≤"},
  {x:12,y:52,w:6,h:5,name:"–ü–∞—Ä–∫ Atat√ºrk"},
  {x:76,y:52,w:7,h:5,name:"–ü–∞—Ä–∫ –ú–µ—Ç–∞–ª–ª—É—Ä–≥"},
];
let map=[],bldgs=[],trees=[];
function buildMap(){
  for(let y=0;y<MAP_H;y++){map[y]=[];for(let x=0;x<MAP_W;x++)map[y][x]=T_EMPTY;}
  for(let ax of AVS) for(let y=0;y<MAP_H;y++) for(let d=0;d<RW;d++) if(ax+d<MAP_W) map[y][ax+d]=T_ROAD;
  for(let sy of STS) for(let x=0;x<MAP_W;x++) for(let d=0;d<RW;d++) if(sy+d<MAP_H) map[sy+d][x]=T_ROAD;
  for(let ax of AVS) for(let sy of STS) for(let dx=0;dx<RW;dx++) for(let dy=0;dy<RW;dy++) if(ax+dx<MAP_W&&sy+dy<MAP_H) map[sy+dy][ax+dx]=T_CROSS;
  for(let p of PARKS) for(let dy=0;dy<p.h;dy++) for(let dx=0;dx<p.w;dx++) if(p.x+dx<MAP_W&&p.y+dy<MAP_H) map[p.y+dy][p.x+dx]=T_PARK;
  for(let p of PARKS) for(let dy=.5;dy<p.h;dy+=1.5) for(let dx=.5;dx<p.w;dx+=1.5) trees.push({x:p.x+dx+(Math.random()-.5)*.3,y:p.y+dy+(Math.random()-.5)*.3,r:5+Math.random()*5});
  trees.sort((a,b)=>(a.x+a.y)-(b.x+b.y));
  const PALS=[
    {top:'#1e2d3d',side:'#0c1825',right:'#091320',win:'#fff799',woff:'#111a22'},
    {top:'#2a1e1e',side:'#180c0c',right:'#120909',win:'#ffd166',woff:'#1e1010'},
    {top:'#1e1e2d',side:'#0c0c1c',right:'#090916',win:'#88ccff',woff:'#11111a'},
    {top:'#252520',side:'#161611',right:'#11110e',win:'#aaffaa',woff:'#181816'},
  ];
  for(let bi=0;bi<STS.length-1;bi++) for(let ai=0;ai<AVS.length-1;ai++){
    const x0=AVS[ai]+RW,y0=STS[bi]+RW,x1=AVS[ai+1],y1=STS[bi+1];
    if(x1-x0<2||y1-y0<2)continue;
    let isPk=false;for(const p of PARKS)if(p.x>=x0&&p.x<x1&&p.y>=y0&&p.y<y1){isPk=true;break;}if(isPk)continue;
    let cx=x0+1;while(cx<x1-1){let cy=y0+1;
      while(cy<y1-1){const bw=Math.min(2+Math.floor(Math.random()*3),x1-cx-1),bh=Math.min(2+Math.floor(Math.random()*3),y1-cy-1),h=1+Math.floor(Math.random()*5);
        if(bw<1||bh<1){cy++;continue;}
        const pal=PALS[Math.floor(Math.random()*PALS.length)];
        bldgs.push({x:cx,y:cy,w:bw,h:bh,height:h,...pal});cy+=bh+1;}cx+=3;}
  }
  bldgs.sort((a,b)=>(a.x+a.y)-(b.x+b.y));
}
buildMap();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CANVAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const cv=document.getElementById('game'),ctx=cv.getContext('2d');
const mm=document.getElementById('minimap'),mctx=mm.getContext('2d');
cv.width=window.innerWidth;cv.height=window.innerHeight;
window.addEventListener('resize',()=>{cv.width=window.innerWidth;cv.height=window.innerHeight;});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ISO MATH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function iso(wx,wy,wz=0){return{sx:(wx-wy)*HT,sy:(wx+wy)*HT*.5-wz*TILE*.5};}
function w2s(wx,wy,wz=0){const p=iso(wx,wy,wz);return{sx:(p.sx-cam.x)*cam.z+cv.width/2,sy:(p.sy-cam.y)*cam.z+cv.height/2};}
let cam={x:0,y:0,z:1.2};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COLLISION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tAt(x,y){const tx=Math.floor(x),ty=Math.floor(y);if(tx<0||ty<0||tx>=MAP_W||ty>=MAP_H)return T_EMPTY;return map[ty][tx];}
function walkable(x,y){const t=tAt(x,y);return t===T_ROAD||t===T_CROSS||t===T_PARK;}
function driveable(x,y){const t=tAt(x,y);return t===T_ROAD||t===T_CROSS;}
function carCanMove(cx,cy,ang,hL,hW){
  const co=Math.cos(ang),si=Math.sin(ang);
  for(const[fl,fs]of[[hL,.3],[hL,-.3],[-hL,.3],[-hL,-.3],[.1,hW],[.1,-hW],[-.1,hW],[-.1,-hW]]){
    if(!driveable(cx+co*fl-si*fs,cy+si*fl+co*fs))return false;
  }return true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INPUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const K={};
document.addEventListener('keydown',e=>{
  K[e.code]=true;
  if(e.code==='KeyE')toggleCar();
  if(e.code==='KeyF'||e.code==='KeyZ')doAttack();
  if(e.code==='KeyR')doShoot();
  if(e.code==='KeyG')doPickup();
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code))e.preventDefault();
});
document.addEventListener('keyup',e=>K[e.code]=false);
// Left click = attack
cv.addEventListener('click',()=>doAttack());
cv.addEventListener('wheel',e=>{cam.z*=e.deltaY>0?.9:1.1;cam.z=Math.max(.3,Math.min(3,cam.z));},{passive:true});

// Joystick
const joyBase=document.getElementById('joy-base'),joyThumb=document.getElementById('joy-thumb');
let jActive=false,jId=null,jOrig={x:0,y:0},jV={x:0,y:0};
const JR=44;
function jReset(){jActive=false;jId=null;jV={x:0,y:0};joyThumb.style.cssText='left:50%;top:50%;transform:translate(-50%,-50%)';}
function jMove(cx,cy){
  const dx=cx-jOrig.x,dy=cy-jOrig.y,d=Math.min(Math.hypot(dx,dy),JR),a=Math.atan2(dy,dx);
  jV={x:Math.cos(a)*d/JR,y:Math.sin(a)*d/JR};
  joyThumb.style.left=`calc(50% + ${Math.cos(a)*d}px)`;
  joyThumb.style.top=`calc(50% + ${Math.sin(a)*d}px)`;
  joyThumb.style.transform='translate(-50%,-50%)';
}
joyBase.addEventListener('touchstart',e=>{e.preventDefault();if(jActive)return;const t=e.changedTouches[0];jActive=true;jId=t.identifier;const r=joyBase.getBoundingClientRect();jOrig={x:r.left+r.width/2,y:r.top+r.height/2};jMove(t.clientX,t.clientY);},{passive:false});
joyBase.addEventListener('touchmove',e=>{e.preventDefault();for(const t of e.changedTouches)if(t.identifier===jId)jMove(t.clientX,t.clientY);},{passive:false});
joyBase.addEventListener('touchend',e=>{for(const t of e.changedTouches)if(t.identifier===jId)jReset();},{passive:false});
joyBase.addEventListener('touchcancel',jReset,{passive:false});
cv.addEventListener('touchstart',e=>{for(const t of e.changedTouches)if(t.clientX<cv.width*.43&&!jActive){jActive=true;jId=t.identifier;jOrig={x:t.clientX,y:t.clientY};jMove(t.clientX,t.clientY);}},{passive:true});
cv.addEventListener('touchmove',e=>{for(const t of e.changedTouches)if(t.identifier===jId)jMove(t.clientX,t.clientY);},{passive:true});
cv.addEventListener('touchend',e=>{for(const t of e.changedTouches)if(t.identifier===jId)jReset();},{passive:true});
jReset();

function mkBtn(id,onP,onR){
  const el=document.getElementById(id);if(!el)return;
  const p=()=>{el.classList.add('on');onP&&onP();};
  const r=()=>{el.classList.remove('on');onR&&onR();};
  el.addEventListener('touchstart',e=>{e.preventDefault();p();},{passive:false});
  el.addEventListener('touchend',e=>{e.preventDefault();r();},{passive:false});
  el.addEventListener('touchcancel',r,{passive:false});
  el.addEventListener('mousedown',p);document.addEventListener('mouseup',r);
}
let bGas=false,bBrk=false,bSprint=false;
mkBtn('b-gas',()=>bGas=true,()=>bGas=false);
mkBtn('b-brk',()=>bBrk=true,()=>bBrk=false);
mkBtn('b-sprint',()=>bSprint=true,()=>bSprint=false);
mkBtn('b-attack',()=>doAttack());
mkBtn('b-car',()=>toggleCar());
mkBtn('b-grab',()=>doPickup());

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CARS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CAR_TYPES=[
  {len:.85,wid:.40,maxSpd:9, acc:5,  brk:10, grip:3.0, col:'#cc3030',col2:'#882020',name:'Sedan'},
  {len:.95,wid:.47,maxSpd:7, acc:3.5,brk:7,  grip:2.2, col:'#3055bb',col2:'#203580',name:'SUV'},
  {len:.80,wid:.38,maxSpd:13,acc:8,  brk:13, grip:3.8, col:'#22bb44',col2:'#168830',name:'–°–ø–æ—Ä—Ç'},
  {len:.85,wid:.40,maxSpd:7, acc:4,  brk:7,  grip:2.5, col:'#d4a800',col2:'#aa8800',name:'–¢–∞–∫—Å–∏'},
  {len:1.2,wid:.52,maxSpd:5, acc:2,  brk:5,  grip:1.8, col:'#555',   col2:'#333',   name:'–ì—Ä—É–∑–æ–≤–∏–∫'},
  {len:.85,wid:.40,maxSpd:9, acc:5,  brk:10, grip:3.0, col:'#993399',col2:'#662266',name:'Sedan'},
  {len:.85,wid:.40,maxSpd:9, acc:5,  brk:10, grip:3.0, col:'#c07020',col2:'#905010',name:'Sedan'},
];
let cars=[];
function spawnCars(){
  const rt=[];for(let y=1;y<MAP_H-1;y++)for(let x=1;x<MAP_W-1;x++)if(map[y][x]===T_ROAD)rt.push({x,y});
  for(let i=0;i<65;i++){
    const pos=rt[Math.floor(Math.random()*rt.length)];
    const typ=CAR_TYPES[Math.floor(Math.random()*CAR_TYPES.length)];
    const onNS=AVS.some(a=>pos.x>=a&&pos.x<a+RW),onEW=STS.some(s=>pos.y>=s&&pos.y<s+RW);
    let angle=0;
    if(onNS&&!onEW)angle=(Math.random()<.5?1:-1)*Math.PI/2;
    else if(onEW)angle=Math.random()<.5?0:Math.PI;
    cars.push({x:pos.x+.5,y:pos.y+.5,angle,spd:0,steer:0,type:typ,driven:false,
      ai:{st:'drive',tm:Math.random()*2,acc:.3,str:0,stuck:0,px:pos.x,py:pos.y,tgt:0}});
  }
}
spawnCars();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEAPONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WTYPES=[
  {id:'pistol', name:'–ü–ò–°–¢–û–õ–ï–¢',icon:'üî´',dmg:28,range:8,  ammo:12,maxAmmo:12,pSpd:20,pCol:'#ffff44',spread:.03},
  {id:'shotgun',name:'–î–†–û–ë–û–í–ò–ö',icon:'üí•',dmg:55,range:3,  ammo:6, maxAmmo:6, pSpd:15,pCol:'#ffaa22',spread:.28},
  {id:'bat',    name:'–î–£–ë–ò–ù–ê',  icon:'üèè',dmg:45,range:1.4,ammo:-1,maxAmmo:-1,pSpd:0, pCol:'',       spread:0},
  {id:'molotov',name:'–ú–û–õ–û–¢–û–í', icon:'üçæ',dmg:80,range:5,  ammo:3, maxAmmo:3, pSpd:10,pCol:'#ff5500',spread:.12},
];
let pickups=[],projectiles=[],effects=[];
let pickupTimer=0;
function spawnPickup(){
  if(pickups.length>=10)return;
  const tiles=[];for(let y=2;y<MAP_H-2;y++)for(let x=2;x<MAP_W-2;x++)if(map[y][x]!==T_EMPTY)tiles.push({x,y});
  const pos=tiles[Math.floor(Math.random()*tiles.length)];
  const wt=WTYPES[Math.floor(Math.random()*WTYPES.length)];
  pickups.push({x:pos.x+.5,y:pos.y+.5,type:wt,bob:Math.random()*Math.PI*2,age:0});
}
for(let i=0;i<8;i++)spawnPickup();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MONSTERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MTYPES=[
  {name:'–ó–û–ú–ë–ò', col:'#44cc44',eyeCol:'#ff2222',spd:1.2,hp:60, maxHp:60, dmg:10,atkR:1.1,sz:1.0},
  {name:'–ú–£–¢–ê–ù–¢',col:'#cc4444',eyeCol:'#ffff00',spd:1.8,hp:100,maxHp:100,dmg:22,atkR:1.2,sz:1.3},
  {name:'–ü–†–ò–ó–†–ê–ö',col:'#8888ff',eyeCol:'#ffffff',spd:2.5,hp:40, maxHp:40, dmg:16,atkR:.9, sz:.85},
  {name:'–ì–û–õ–ï–ú', col:'#887766',eyeCol:'#ff4400',spd:.7, hp:200,maxHp:200,dmg:38,atkR:1.5,sz:1.5},
];
let monsters=[];
function spawnMonster(far=false){
  if(monsters.length>=22)return;
  const tiles=[];for(let y=2;y<MAP_H-2;y++)for(let x=2;x<MAP_W-2;x++)if(map[y][x]===T_ROAD||map[y][x]===T_PARK)tiles.push({x,y});
  const arr=far?tiles.filter(t=>Math.hypot(t.x-player.x,t.y-player.y)>14):tiles;
  const pool=arr.length?arr:tiles;
  const pos=pool[Math.floor(Math.random()*pool.length)];
  const mt=MTYPES[Math.floor(Math.random()*MTYPES.length)];
  monsters.push({x:pos.x+.5,y:pos.y+.5,angle:Math.random()*Math.PI*2,hp:mt.maxHp,type:mt,
    state:'wander',stTm:2+Math.random()*3,wandAng:Math.random()*Math.PI*2,atkTm:0,fr:0,frTm:0});
}
for(let i=0;i<18;i++)spawnMonster(false);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PLAYER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let player={
  x:44.5,y:44.5,angle:Math.PI*.75,spd:0,
  inCar:false,car:null,
  fr:0,frTm:0,facing:'idle',
  hp:100,maxHp:100,armor:0,maxArmor:100,
  weapon:null,
  atkCd:0,shootCd:0,atkAnim:0,
  hitFlash:0,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WANTED ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let wanted=0,wDecay=0;
function setWanted(n){wanted=Math.max(0,Math.min(5,n));refreshHUD();}
function refreshHUD(){
  const ws=document.getElementById('wanted-row');ws.innerHTML='';
  for(let i=0;i<5;i++){const s=document.createElement('span');s.textContent='‚òÖ';s.style.color=i<wanted?'#ff3333':'#222';if(i<wanted)s.style.textShadow='0 0 6px #ff3333';ws.appendChild(s);}
  document.getElementById('hp-bar').style.width=(player.hp/player.maxHp*100)+'%';
  document.getElementById('armor-bar').style.width=(player.armor/player.maxArmor*100)+'%';
  const w=player.weapon;
  document.getElementById('p-weapon').textContent=w?`${w.icon} ${w.name}`:'‚úä –ö–£–õ–ê–ö–ò';
  document.getElementById('p-ammo').textContent=w&&w.ammo>=0?`${w.ammo}/${w.maxAmmo}`:'';
}
refreshHUD();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIFY / LOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let notTm=0;
function notify(msg,col='#00ffff'){
  const el=document.getElementById('notify');
  el.textContent=msg;el.style.color=col;el.style.textShadow=`0 0 18px ${col}`;el.style.opacity='1';notTm=2.2;
}
const cLines=[];
function cLog(msg){
  cLines.unshift(msg);if(cLines.length>5)cLines.pop();
  document.getElementById('clog').innerHTML=cLines.join('<br>');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMBAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doAttack(){
  if(player.inCar||player.atkCd>0)return;
  const w=player.weapon;
  const isMelee=!w||w.id==='bat';
  if(!isMelee){doShoot();return;}
  // Melee
  const range=w?1.4:1.1;
  const dmg=w?w.dmg:15;
  player.atkCd=.38;player.atkAnim=.32;
  let hit=false;
  for(let i=monsters.length-1;i>=0;i--){
    const m=monsters[i];
    const d=Math.hypot(m.x-player.x,m.y-player.y);
    if(d<range){
      const dealt=dmg+Math.floor(Math.random()*8)-3;
      m.hp-=dealt;m.state='chase';
      effects.push({type:'hit',x:m.x,y:m.y,t:.4,col:'#ff8844'});
      cLog(`‚öî ${m.type.name} -${dealt}HP`);hit=true;
      if(m.hp<=0){cLog(`üíÄ ${m.type.name} –£–ù–ò–ß–¢–û–ñ–ï–ù`);monsters.splice(i,1);setTimeout(()=>spawnMonster(true),8000);}
    }
  }
  if(!hit)cLog('‚öî –ü—Ä–æ–º–∞—Ö...');
}

function doShoot(){
  if(player.inCar)return;
  const w=player.weapon;
  if(!w||w.id==='bat'){notify('–ù–µ—Ç –æ–≥–Ω–µ—Å—Ç—Ä–µ–ª—å–Ω–æ–≥–æ –æ—Ä—É–∂–∏—è','#ff4444');return;}
  if(w.ammo===0){notify('–ù–ï–¢ –ü–ê–¢–†–û–ù–û–í','#ff4444');return;}
  if(player.shootCd>0)return;
  player.shootCd=w.id==='shotgun'?.65:w.id==='molotov'?1.1:.22;
  player.atkAnim=.18;
  if(w.ammo>0){w.ammo--;if(w.ammo===0){setTimeout(()=>{player.weapon=null;notify('–†–ê–ó–†–Ø–ñ–ï–ù','#ff4444');refreshHUD();},300);}}
  // Auto-aim toward nearest monster in range
  let aimAng=player.angle; // default = facing
  let nearDist=w.range*1.6,nearest=null;
  for(const m of monsters){const d=Math.hypot(m.x-player.x,m.y-player.y);if(d<nearDist){nearDist=d;nearest=m;}}
  if(nearest)aimAng=Math.atan2(nearest.y-player.y,nearest.x-player.x);
  const count=w.id==='shotgun'?5:1;
  for(let i=0;i<count;i++){
    const sp=(Math.random()-.5)*w.spread+(i-(count-1)/2)*w.spread*.4;
    const ang=aimAng+sp;
    projectiles.push({x:player.x+Math.cos(ang)*.6,y:player.y+Math.sin(ang)*.6,vx:Math.cos(ang)*w.pSpd,vy:Math.sin(ang)*w.pSpd,dmg:w.dmg/count,range:w.range,traveled:0,col:w.pCol,type:w.id});
  }
  effects.push({type:'flash',x:player.x,y:player.y,t:.13,col:w.pCol});
  refreshHUD();
}

function doPickup(){
  if(player.inCar)return;
  let best=null,bd=1.2;
  for(const p of pickups){const d=Math.hypot(p.x-player.x,p.y-player.y);if(d<bd){bd=d;best=p;}}
  if(best){player.weapon={...best.type,ammo:best.type.maxAmmo};pickups.splice(pickups.indexOf(best),1);notify(`–ü–æ–¥–æ–±—Ä–∞–ª ${best.type.name}`,best.type.pCol||'#00ffff');refreshHUD();}
  else notify('–ù–µ—Ç –æ—Ä—É–∂–∏—è —Ä—è–¥–æ–º','#555');
}

function toggleCar(){
  if(player.inCar){
    const c=player.car;
    const ex=c.x+Math.cos(c.angle+Math.PI/2)*1.2,ey=c.y+Math.sin(c.angle+Math.PI/2)*1.2;
    player.inCar=false;player.car=null;c.driven=false;c.spd*=.05;
    player.x=walkable(ex,ey)?ex:c.x;player.y=walkable(ex,ey)?ey:c.y;
    document.getElementById('drive-panel').style.display='none';
    document.getElementById('walk-panel').style.display='flex';
    document.getElementById('status').textContent='–ù–ê –ù–û–ì–ê–•';
    notify('–í—ã—à–µ–ª –∏–∑ –º–∞—à–∏–Ω—ã','#aaa');
  } else {
    let best=null,bd=1.8;for(const c of cars){const d=Math.hypot(c.x-player.x,c.y-player.y);if(d<bd){bd=d;best=c;}}
    if(best){player.inCar=true;player.car=best;best.driven=true;setWanted(wanted+1);document.getElementById('drive-panel').style.display='flex';document.getElementById('walk-panel').style.display='none';document.getElementById('status').textContent='–í –ú–ê–®–ò–ù–ï: '+best.type.name;notify('–£–ì–ù–ê–õ –ú–ê–®–ò–ù–£!','#ff3333');}
    else notify('–ù–µ—Ç –º–∞—à–∏–Ω—ã —Ä—è–¥–æ–º','#555');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DRIVE INPUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function driveThrottle(){
  let v=0;
  if(K['KeyW']||K['ArrowUp']||bGas)   v= 1;
  if(K['KeyS']||K['ArrowDown']||bBrk) v=-1;
  if(jActive&&Math.abs(jV.y)>.12)v=Math.sign(-jV.y);
  return v;
}
function driveSteer(){
  let v=0;
  if(K['KeyA']||K['ArrowLeft']) v=-1;
  if(K['KeyD']||K['ArrowRight'])v= 1;
  if(jActive&&Math.abs(jV.x)>.12)v=jV.x;
  return Math.max(-1,Math.min(1,v));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAR PHYSICS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCar(car,dt,isPlayer){
  const T=car.type;
  let throttle=0,steerIn=0;
  if(isPlayer){throttle=driveThrottle();steerIn=driveSteer();}
  else{aiDrive(car,dt);throttle=car.ai.acc>0?1:car.ai.acc<0?-1:0;steerIn=Math.max(-1,Math.min(1,car.ai.str*2));}

  // Speed
  if(throttle>0)       car.spd=Math.min(T.maxSpd,car.spd+T.acc*dt);
  else if(throttle<0)  car.spd=Math.max(-T.maxSpd*.4,car.spd-T.brk*dt);
  else                 car.spd*=(1-Math.min(1,3*dt));
  if(Math.abs(car.spd)<.018)car.spd=0;

  // Steering (only works when moving)
  if(Math.abs(car.spd)>.08){
    car.angle+=steerIn*T.grip*Math.min(1,Math.abs(car.spd)/2)*dt*(car.spd>0?1:-1);
  }

  // Move along heading
  const nx=car.x+Math.cos(car.angle)*car.spd*dt;
  const ny=car.y+Math.sin(car.angle)*car.spd*dt;
  const hL=T.len*.4,hW=T.wid*.38;
  if(carCanMove(nx,ny,car.angle,hL,hW)){car.x=nx;car.y=ny;}
  else if(carCanMove(nx,car.y,car.angle,hL,hW)){car.x=nx;car.spd*=.6;}
  else if(carCanMove(car.x,ny,car.angle,hL,hW)){car.y=ny;car.spd*=.6;}
  else{car.spd*=-.28;if(isPlayer)notify('–ë–£–ú!','#ff6600');}
  car.x=Math.max(.5,Math.min(MAP_W-.5,car.x));car.y=Math.max(.5,Math.min(MAP_H-.5,car.y));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI CARS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function aiDrive(car,dt){
  const ai=car.ai;ai.tm-=dt;
  const mv=Math.hypot(car.x-ai.px,car.y-ai.py);ai.px=car.x;ai.py=car.y;
  if(mv<.005)ai.stuck+=dt;else ai.stuck*=.8;
  if(ai.stuck>2){ai.acc=-.6;ai.str=(Math.random()<.5?1:-1)*.5;ai.stuck=0;ai.tm=1.5;return;}
  if(ai.tm<=0){const r=Math.random();if(r<.06){ai.st='wait';ai.tm=1+Math.random()*2;}else if(r<.25&&Math.abs(car.spd)>.3){ai.st='turn';ai.tgt=car.angle+(Math.random()<.5?1:-1)*Math.PI/2;ai.tm=.8;}else{ai.st='drive';ai.tm=2+Math.random()*4;}}
  if(ai.st==='wait'){ai.acc=0;ai.str=0;return;}
  const lx=car.x+Math.cos(car.angle)*2,ly=car.y+Math.sin(car.angle)*2;
  if(!driveable(lx,ly)){
    let bA=car.angle,bS=-1;for(let i=0;i<16;i++){const ta=car.angle+(i/16)*Math.PI*2,tx=car.x+Math.cos(ta)*1.8,ty=car.y+Math.sin(ta)*1.8;if(driveable(tx,ty)){const d=1-Math.abs(aDiff(ta,car.angle))/Math.PI;if(d>bS){bS=d;bA=ta;}}}
    ai.str=Math.sign(aDiff(bA,car.angle))*.5;ai.acc=.3;return;
  }
  if(ai.st==='turn'){const d=aDiff(ai.tgt,car.angle);ai.str=Math.sign(d)*.5;ai.acc=.4;if(Math.abs(d)<.08)ai.st='drive';}
  else{ai.str*=(1-4*dt);ai.acc=car.type.acc*.5;}
}
function aDiff(a,b){let d=((a-b)+Math.PI*3)%(Math.PI*2)-Math.PI;return d;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WALKING ‚Äî FIXED (not inverted) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Isometric screen space:
//   Screen UP    = world NW = wx-1, wy-1
//   Screen DOWN  = world SE = wx+1, wy+1
//   Screen LEFT  = world SW = wx-1, wy+1  (but to player it feels "left")
//   Screen RIGHT = world NE = wx+1, wy-1
// So W = move NW (both x and y decrease), which is "up" on screen ‚Äî correct, not inverted
function walkPlayer(dt){
  let wx=0,wy=0; // world-space movement vector
  if(K['KeyW']||K['ArrowUp'])   {wx-=1;wy-=1;}  // up-left on screen (NW)
  if(K['KeyS']||K['ArrowDown']) {wx+=1;wy+=1;}  // down-right on screen (SE)
  if(K['KeyA']||K['ArrowLeft']) {wx-=1;wy+=1;}  // down-left on screen (SW)
  if(K['KeyD']||K['ArrowRight']){wx+=1;wy-=1;}  // up-right on screen (NE)
  // Joystick: jV.x/y is screen-space (right=+x, down=+y)
  // Screen right (+jV.x) ‚Üí world NE (+wx, -wy)
  // Screen down (+jV.y)  ‚Üí world SE (+wx, +wy)
  if(jActive){
    wx+=jV.x-jV.y;
    wy+=-jV.x+jV.y;  // fixed: was -jV.x-jV.y (inverted y), now correct
  }
  const len=Math.hypot(wx,wy);
  if(len>.04){
    wx/=len;wy/=len;
    const spd=(K['ShiftLeft']||K['ShiftRight']||bSprint)?5.5:3;
    player.angle=Math.atan2(wy,wx);
    player.spd=spd;
    player.frTm+=dt;if(player.frTm>.1){player.fr=(player.fr+1)%8;player.frTm=0;}
    const nx=player.x+wx*spd*dt,ny=player.y+wy*spd*dt;
    if(walkable(nx,player.y))player.x=nx;
    if(walkable(player.x,ny))player.y=ny;
  } else {
    player.spd=0;
  }
  player.x=Math.max(.5,Math.min(MAP_W-.5,player.x));
  player.y=Math.max(.5,Math.min(MAP_H-.5,player.y));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MONSTER AI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateMonsters(dt){
  for(const m of monsters){
    const dx=player.x-m.x,dy=player.y-m.y,dist=Math.hypot(dx,dy);
    m.stTm-=dt;m.atkTm=Math.max(0,m.atkTm-dt);
    m.frTm+=dt;if(m.frTm>.14){m.fr=(m.fr+1)%4;m.frTm=0;}
    if(dist<9&&m.state==='wander')m.state='chase';
    if(dist>14&&m.state==='chase')m.state='wander';
    if(m.state==='wander'){
      if(m.stTm<=0){m.wandAng+=(Math.random()-.5)*Math.PI*.9;m.stTm=1.5+Math.random()*2;}
      const sx=m.x+Math.cos(m.wandAng)*m.type.spd*.45*dt,sy=m.y+Math.sin(m.wandAng)*m.type.spd*.45*dt;
      if(walkable(sx,sy)){m.x=sx;m.y=sy;m.angle=m.wandAng;}else m.wandAng+=Math.PI*.5;
    } else {
      const ang=Math.atan2(dy,dx);m.angle=ang;
      const spd=m.type.spd*dt;
      const nx=m.x+Math.cos(ang)*spd,ny=m.y+Math.sin(ang)*spd;
      if(walkable(nx,ny)){m.x=nx;m.y=ny;}else if(walkable(nx,m.y))m.x=nx;else if(walkable(m.x,ny))m.y=ny;
      if(dist<m.type.atkR&&m.atkTm<=0&&!player.inCar){
        let dmg=m.type.dmg;
        if(player.armor>0){const ab=Math.min(player.armor,dmg*.5);player.armor-=ab;dmg-=ab;}
        player.hp=Math.max(0,player.hp-dmg);player.hitFlash=.3;
        cLog(`üí• ${m.type.name} –∞—Ç–∞–∫—É–µ—Ç -${dmg}HP`);
        m.atkTm=1.2/m.type.spd;refreshHUD();
        if(player.hp<=0)playerDead();
      }
    }
    m.x=Math.max(.5,Math.min(MAP_W-.5,m.x));m.y=Math.max(.5,Math.min(MAP_H-.5,m.y));
  }
}
function playerDead(){notify('–ï–† –¢–û–°–¢–ò–ö –ü–ê–õ... –í–û–ó–†–û–ñ–î–ï–ù–ò–ï','#ff2222');setTimeout(()=>{player.hp=player.maxHp;player.armor=0;player.x=44.5;player.y=44.5;if(player.inCar){player.car.driven=false;player.inCar=false;player.car=null;document.getElementById('drive-panel').style.display='none';document.getElementById('walk-panel').style.display='flex';}refreshHUD();},1800);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROJECTILES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateProjectiles(dt){
  for(let i=projectiles.length-1;i>=0;i--){
    const p=projectiles[i];
    p.x+=p.vx*dt;p.y+=p.vy*dt;p.traveled+=Math.hypot(p.vx,p.vy)*dt;
    let dead=p.traveled>p.range||!walkable(p.x,p.y);
    for(let j=monsters.length-1;!dead&&j>=0;j--){
      const m=monsters[j];
      if(Math.hypot(m.x-p.x,m.y-p.y)<.4){
        const d=p.dmg+Math.floor(Math.random()*6);m.hp-=d;m.state='chase';
        effects.push({type:'hit',x:m.x,y:m.y,t:.35,col:p.col});
        dead=true;
        cLog(`üî´ ${m.type.name} -${Math.round(d)}HP`);
        if(m.hp<=0){cLog(`üíÄ ${m.type.name} –£–ù–ò–ß–¢–û–ñ–ï–ù`);monsters.splice(j,1);setTimeout(()=>spawnMonster(true),8000);}
      }
    }
    if(dead){if(p.type==='molotov')effects.push({type:'explosion',x:p.x,y:p.y,t:.8,col:'#ff4400'});projectiles.splice(i,1);}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UPDATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function update(dt){
  if(notTm>0){notTm-=dt;if(notTm<=0)document.getElementById('notify').style.opacity='0';}
  wDecay+=dt;if(wDecay>25&&wanted>0){setWanted(wanted-1);wDecay=0;}
  player.atkCd=Math.max(0,player.atkCd-dt);
  player.shootCd=Math.max(0,player.shootCd-dt);
  player.hitFlash=Math.max(0,player.hitFlash-dt);
  player.atkAnim=Math.max(0,player.atkAnim-dt);

  if(player.inCar){
    updateCar(player.car,dt,true);
    player.x=player.car.x;player.y=player.car.y;player.angle=player.car.angle;
    document.getElementById('spd').textContent=Math.round(Math.abs(player.car.spd)*20);
  } else {
    walkPlayer(dt);
    document.getElementById('spd').textContent=Math.round(player.spd*18);
  }
  for(const c of cars)if(!c.driven)updateCar(c,dt,false);
  updateMonsters(dt);
  updateProjectiles(dt);
  for(let i=effects.length-1;i>=0;i--){effects[i].t-=dt;if(effects[i].t<=0)effects.splice(i,1);}
  for(const p of pickups){p.bob+=dt*2.2;p.age+=dt;}
  pickupTimer+=dt;if(pickupTimer>18){pickupTimer=0;spawnPickup();}

  // Pickup hint
  const nearPk=pickups.some(p=>!player.inCar&&Math.hypot(p.x-player.x,p.y-player.y)<1.2);
  const gb=document.getElementById('b-grab');
  if(nearPk)gb.classList.add('vis');else gb.classList.remove('vis');

  // Camera
  const fp=w2s(player.x,player.y);
  cam.x+=(((fp.sx-cv.width/2)/cam.z+cam.x)-cam.x)*8*dt;
  cam.y+=(((fp.sy-cv.height/2)/cam.z+cam.y)-cam.y)*8*dt;

  let loc='–ê–ª–º–∞—Ç—ã';for(const p of PARKS)if(player.x>=p.x&&player.x<p.x+p.w&&player.y>=p.y&&player.y<p.y+p.h){loc=p.name;break;}
  document.getElementById('loc').textContent=loc;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHADE HELPER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shade(hex,d){
  const r=Math.max(0,Math.min(255,parseInt(hex.slice(1,3),16)+d));
  const g=Math.max(0,Math.min(255,parseInt(hex.slice(3,5),16)+d));
  const b=Math.max(0,Math.min(255,parseInt(hex.slice(5,7),16)+d));
  return`rgb(${r},${g},${b})`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  ctx.clearRect(0,0,cv.width,cv.height);
  const Z=cam.z;

  // Sky
  const sky=ctx.createLinearGradient(0,0,0,cv.height);sky.addColorStop(0,'#04040f');sky.addColorStop(1,'#0a0a20');
  ctx.fillStyle=sky;ctx.fillRect(0,0,cv.width,cv.height);
  ctx.fillStyle='rgba(255,255,230,0.32)';
  for(let i=0;i<150;i++)ctx.fillRect((i*137.5)%cv.width,(i*97.3)%cv.height*.45,1,1);

  // Tiles
  for(let sum=0;sum<MAP_W+MAP_H-1;sum++){
    const xS=Math.max(0,sum-(MAP_H-1)),xE=Math.min(sum,MAP_W-1);
    for(let tx=xS;tx<=xE;tx++){
      const ty=sum-tx;if(ty<0||ty>=MAP_H)continue;
      const t=map[ty][tx];
      const p=iso(tx+.5,ty+.5);
      const sx=(p.sx-cam.x)*Z+cv.width/2,sy=(p.sy-cam.y)*Z+cv.height/2;
      const hw=HT*Z,hh=HT*Z*.5;
      if(sx<-hw*2||sx>cv.width+hw*2||sy<-hh*4||sy>cv.height+hh*2)continue;
      let fill;
      if(t===T_ROAD)fill='#17171f';else if(t===T_CROSS)fill='#121216';else if(t===T_PARK)fill='#152819';else continue;
      ctx.beginPath();ctx.moveTo(sx,sy-hh);ctx.lineTo(sx+hw,sy);ctx.lineTo(sx,sy+hh);ctx.lineTo(sx-hw,sy);ctx.closePath();
      ctx.fillStyle=fill;ctx.fill();
      if(t===T_ROAD){ctx.strokeStyle='rgba(255,200,30,0.09)';ctx.lineWidth=.8;ctx.setLineDash([3,5]);ctx.beginPath();ctx.moveTo(sx-hw*.5,sy);ctx.lineTo(sx+hw*.5,sy);ctx.stroke();ctx.setLineDash([]);}
    }
  }

  // Trees
  for(const tr of trees){
    const p=iso(tr.x,tr.y);const sx=(p.sx-cam.x)*Z+cv.width/2,sy=(p.sy-cam.y)*Z+cv.height/2;
    if(sx<-40||sx>cv.width+40||sy<-60||sy>cv.height+20)continue;
    const r=tr.r*Z*.7;
    ctx.fillStyle='#271406';ctx.fillRect(sx-1.1*Z,sy-r*.4,2.2*Z,r*.5);
    ctx.beginPath();ctx.ellipse(sx,sy+2,r*.64,r*.3,0,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.18)';ctx.fill();
    ctx.beginPath();ctx.arc(sx,sy-r*.4,r,0,Math.PI*2);ctx.fillStyle='#162e19';ctx.fill();
    ctx.beginPath();ctx.arc(sx-r*.15,sy-r*.68,r*.7,0,Math.PI*2);ctx.fillStyle='#1e4828';ctx.fill();
    ctx.beginPath();ctx.arc(sx+r*.1,sy-r*.98,r*.5,0,Math.PI*2);ctx.fillStyle='#255a34';ctx.fill();
  }

  // Buildings
  function bp(bx,by,bz){const p=iso(bx,by,bz);return{sx:(p.sx-cam.x)*Z+cv.width/2,sy:(p.sy-cam.y)*Z+cv.height/2};}
  function bpoly(pts,fill,stk){ctx.beginPath();ctx.moveTo(pts[0].sx,pts[0].sy);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i].sx,pts[i].sy);ctx.closePath();if(fill){ctx.fillStyle=fill;ctx.fill();}if(stk){ctx.strokeStyle=stk;ctx.lineWidth=.4;ctx.stroke();}}
  for(const b of bldgs){
    const p0=iso(b.x,b.y);const bsx=(p0.sx-cam.x)*Z+cv.width/2;if(bsx<-350||bsx>cv.width+350)continue;
    const H=b.height;
    bpoly([bp(b.x,b.y+b.h,H),bp(b.x+b.w,b.y+b.h,H),bp(b.x+b.w,b.y+b.h,0),bp(b.x,b.y+b.h,0)],b.side,'#020209');
    bpoly([bp(b.x+b.w,b.y,H),bp(b.x+b.w,b.y+b.h,H),bp(b.x+b.w,b.y+b.h,0),bp(b.x+b.w,b.y,0)],b.right,'#020209');
    bpoly([bp(b.x,b.y,H),bp(b.x+b.w,b.y,H),bp(b.x+b.w,b.y+b.h,H),bp(b.x,b.y+b.h,H)],b.top,'#020209');
    const wr=Math.min(H*2,6),wc=Math.min(b.w*2,5);
    for(let row=0;row<wr;row++)for(let col=0;col<wc;col++){
      const wz=(row+.35)/wr*H,wx=b.x+(col+.3)/wc*b.w,wy=b.y+b.h-.02;
      const wp=bp(wx,wy,wz);const lit=Math.sin(b.x*3.1+b.y*7.3+row*5.7+col*2.9)>-.4;
      ctx.beginPath();ctx.rect(wp.sx-1.5*Z,wp.sy-2*Z,2.8*Z,2.8*Z);ctx.fillStyle=lit?b.win:b.woff;if(lit){ctx.shadowBlur=4*Z;ctx.shadowColor=b.win;}ctx.fill();ctx.shadowBlur=0;
    }
    for(let row=0;row<wr;row++)for(let col=0;col<wc;col++){
      const wz=(row+.35)/wr*H,wx=b.x+b.w-.02,wy=b.y+(col+.3)/wc*b.h;
      const wp=bp(wx,wy,wz);const lit=Math.sin(b.x*2.3+b.y*5.1+row*4.3+col*3.7)>-.4;
      ctx.beginPath();ctx.rect(wp.sx-1.5*Z,wp.sy-2*Z,2.8*Z,2.8*Z);ctx.fillStyle=lit?b.win:b.woff;if(lit){ctx.shadowBlur=4*Z;ctx.shadowColor=b.win;}ctx.fill();ctx.shadowBlur=0;
    }
  }

  // Weapon pickups
  for(const pk of pickups){
    const p=iso(pk.x,pk.y);const sx=(p.sx-cam.x)*Z+cv.width/2,sy=(p.sy-cam.y)*Z+cv.height/2;
    if(sx<-80||sx>cv.width+80)continue;
    const bob=Math.sin(pk.bob)*5*Z,wt=pk.type,col=wt.pCol||'#00ffff';
    ctx.beginPath();ctx.ellipse(sx,sy+2*Z,12*Z,5*Z,0,0,Math.PI*2);ctx.fillStyle=col+'14';ctx.fill();ctx.strokeStyle=col+'55';ctx.lineWidth=1.2*Z;ctx.stroke();
    ctx.save();ctx.translate(sx,sy-7*Z+bob);
    if(wt.id==='bat'){
      ctx.save();ctx.rotate(-.4);ctx.fillStyle='#8B5E3C';ctx.beginPath();ctx.roundRect(-1.5*Z,-14*Z,3*Z,20*Z,1.5*Z);ctx.fill();ctx.strokeStyle='#5c3a1e';ctx.lineWidth=.5*Z;ctx.stroke();ctx.fillStyle='#C4873A';ctx.beginPath();ctx.ellipse(0,-14*Z,5*Z,5*Z,0,0,Math.PI*2);ctx.fill();ctx.restore();
    } else if(wt.id==='pistol'){
      ctx.save();ctx.rotate(.2);ctx.fillStyle='#555';ctx.beginPath();ctx.roundRect(-5*Z,-8*Z,10*Z,7*Z,2*Z);ctx.fill();ctx.fillStyle='#444';ctx.beginPath();ctx.roundRect(-2*Z,-2*Z,5*Z,10*Z,1.5*Z);ctx.fill();ctx.fillStyle='#333';ctx.fillRect(-6*Z,-9*Z,8*Z,3*Z);ctx.restore();
    } else if(wt.id==='shotgun'){
      ctx.save();ctx.rotate(.1);ctx.fillStyle='#333';ctx.beginPath();ctx.roundRect(-8*Z,-4*Z,16*Z,3.5*Z,1*Z);ctx.fill();ctx.beginPath();ctx.roundRect(-8*Z,-8*Z,16*Z,3.5*Z,1*Z);ctx.fill();ctx.fillStyle='#8B5E3C';ctx.beginPath();ctx.roundRect(-3*Z,-8*Z,5*Z,14*Z,2*Z);ctx.fill();ctx.restore();
    } else {
      const grd=ctx.createLinearGradient(-5*Z,0,5*Z,0);grd.addColorStop(0,'rgba(255,100,0,.35)');grd.addColorStop(.5,'rgba(255,60,0,.8)');grd.addColorStop(1,'rgba(255,100,0,.35)');ctx.fillStyle=grd;ctx.beginPath();ctx.roundRect(-5*Z,-8*Z,10*Z,14*Z,4*Z);ctx.fill();ctx.strokeStyle='rgba(255,180,0,.9)';ctx.lineWidth=1.2*Z;ctx.stroke();ctx.fillStyle='rgba(255,80,0,.6)';ctx.beginPath();ctx.roundRect(-2.5*Z,-13*Z,5*Z,6*Z,1*Z);ctx.fill();ctx.stroke();const fl=Math.sin(pk.bob*1.8);ctx.fillStyle='rgba(255,200,0,.9)';ctx.beginPath();ctx.arc(0,-14*Z+fl*2*Z,3*Z,0,Math.PI*2);ctx.fill();ctx.shadowBlur=8*Z;ctx.shadowColor='#ff6600';ctx.fill();ctx.shadowBlur=0;
    }
    ctx.restore();
    const pulse=.7+Math.sin(pk.bob*.8)*.3;
    ctx.font=`bold ${7*Z}px Courier New`;ctx.textAlign='center';ctx.textBaseline='alphabetic';ctx.fillStyle=col;ctx.globalAlpha=pulse;ctx.shadowBlur=5*Z;ctx.shadowColor=col;ctx.fillText(wt.name,sx,sy+22*Z+bob);ctx.globalAlpha=1;ctx.shadowBlur=0;
  }

  // Depth-sorted entities
  const ents=[...monsters.map(m=>({e:m,d:m.x+m.y,k:'m'})),...cars.filter(c=>c!==player.car).map(c=>({e:c,d:c.x+c.y,k:'c'}))].sort((a,b)=>a.d-b.d);
  for(const{e,k} of ents){if(k==='m')drawMonster(e,Z);else drawCar(e,Z);}
  if(player.inCar)drawCar(player.car,Z);
  if(!player.inCar)drawErTostik(Z);

  // Projectiles
  for(const p of projectiles){
    const sp=w2s(p.x,p.y,.15);
    if(p.type==='molotov'){
      ctx.shadowBlur=14*Z;ctx.shadowColor='#ff6600';ctx.beginPath();ctx.arc(sp.sx,sp.sy,5*Z,0,Math.PI*2);ctx.fillStyle='#ff4400';ctx.fill();ctx.beginPath();ctx.arc(sp.sx,sp.sy-4*Z,3*Z,0,Math.PI*2);ctx.fillStyle='#ffaa00';ctx.fill();ctx.shadowBlur=0;
    } else {
      const r=p.type==='shotgun'?2.6*Z:2*Z;const ang=Math.atan2(p.vy,p.vx)+Math.PI;
      for(let t=1;t<=4;t++){const tx=sp.sx+Math.cos(ang)*t*r*1.6,ty=sp.sy+Math.sin(ang)*t*r*1.6;ctx.beginPath();ctx.arc(tx,ty,r*(1-t/4)*.7,0,Math.PI*2);ctx.fillStyle=p.col+(Math.floor((1-t/4)*80)).toString(16).padStart(2,'0');ctx.fill();}
      ctx.shadowBlur=10*Z;ctx.shadowColor=p.col;ctx.beginPath();ctx.arc(sp.sx,sp.sy,r,0,Math.PI*2);ctx.fillStyle=p.col;ctx.fill();ctx.beginPath();ctx.arc(sp.sx,sp.sy,r*.42,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();ctx.shadowBlur=0;
    }
  }

  // Effects
  for(const ef of effects){
    const sp=w2s(ef.x,ef.y,.2);const frac=ef.type==='explosion'?ef.t/.8:ef.t/.4;
    if(ef.type==='hit'){
      ctx.beginPath();ctx.arc(sp.sx,sp.sy,20*Z*frac,0,Math.PI*2);ctx.fillStyle=ef.col+(Math.floor(frac*88)).toString(16).padStart(2,'0');ctx.fill();
      ctx.font=`bold ${10*Z}px Courier New`;ctx.textAlign='center';ctx.fillStyle=ef.col;ctx.fillText('HIT',sp.sx,sp.sy-12*Z*frac);
    } else if(ef.type==='explosion'){
      const rr=(1-frac)*34*Z;ctx.beginPath();ctx.arc(sp.sx,sp.sy,rr,0,Math.PI*2);ctx.fillStyle=`rgba(255,${Math.floor(frac*140)},0,${frac*.65})`;ctx.fill();ctx.shadowBlur=rr;ctx.shadowColor='#ff4400';ctx.stroke();ctx.shadowBlur=0;
    } else if(ef.type==='flash'){
      ctx.beginPath();ctx.arc(sp.sx,sp.sy,22*Z*frac,0,Math.PI*2);ctx.fillStyle=ef.col+(Math.floor(frac*55)).toString(16).padStart(2,'0');ctx.fill();
    }
  }

  // Car enter hint
  if(!player.inCar){
    let best=null,bd=1.8;for(const c of cars){const d=Math.hypot(c.x-player.x,c.y-player.y);if(d<bd){bd=d;best=c;}}
    if(best){
      const sp=w2s(best.x,best.y,.2);ctx.strokeStyle='#44aaff';ctx.lineWidth=2;ctx.setLineDash([4,4]);ctx.beginPath();ctx.arc(sp.sx,sp.sy,28*Z,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);ctx.font=`bold ${9*Z}px Courier New`;ctx.fillStyle='#44aaff';ctx.textAlign='center';ctx.fillText('[E] –£–ì–ù–ê–¢–¨',sp.sx,sp.sy-38*Z);
    }
  }

  if(player.hitFlash>0){ctx.fillStyle=`rgba(255,0,0,${player.hitFlash*.32})`;ctx.fillRect(0,0,cv.width,cv.height);}
  drawMinimap();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ER TOSTIK ‚Äî ISOMETRIC PIXEL SPRITE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Renders the 32x32 pixel sprite adapted for isometric projection:
// - Apply isometric skew: each row is offset horizontally and vertically
// - Scale: each "pixel" becomes a small skewed quad in screen space
// - Animate between frames based on player state
function drawErTostik(Z){
  const pp=iso(player.x,player.y,0);
  const cx=(pp.sx-cam.x)*Z+cv.width/2;
  const cy=(pp.sy-cam.y)*Z+cv.height/2;

  // Choose animation frame
  const moving=player.spd>0;
  const attacking=player.atkAnim>0;
  let frame;
  if(attacking)frame=ATTACK1;
  else if(moving&&(player.fr%2===0))frame=WALK2;
  else frame=IDLE1;

  // Pixel size in isometric (pixels are squashed and skewed for iso look)
  const PS=2.2*Z;      // base pixel size
  // Isometric squash: pixels appear squashed vertically by 0.5
  // We also need to orient the sprite "into" the scene
  // The sprite faces south-east in iso space (toward viewer)
  const SX=PS;         // pixel width in screen x
  const SY=PS*0.5;     // pixel height in screen y (squashed for iso)

  // Center the 32x32 sprite: sprite is centered horizontally, feet at cy
  const offX=cx - 16*SX;
  const offY=cy - 30*SY; // shift up so feet are at ground level

  ctx.save();
  for(let row=0;row<32;row++){
    for(let col=0;col<32;col++){
      const key=frame[row]&&frame[row][col];
      if(!key||key===0)continue;
      const color=C[key];
      if(!color)continue;

      // Isometric offset: each column shifts right+down, each row shifts right+down differently
      // For a "flat facing viewer" iso projection: standard screen-space rendering with squash
      const px=offX+col*SX;
      const py=offY+row*SY;

      ctx.fillStyle=color;
      ctx.fillRect(px,py,SX+.5,SY+.5);
    }
  }

  // Shadow under feet
  ctx.beginPath();ctx.ellipse(cx,cy+2*Z,10*Z,4*Z,0,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fill();

  // Scarf glow when sprinting or attacking
  if(player.spd>5||attacking){
    ctx.shadowBlur=12*Z;ctx.shadowColor='#00ffff44';
    ctx.beginPath();ctx.ellipse(cx,cy-20*Z,14*Z,18*Z,0,0,Math.PI*2);
    ctx.strokeStyle='rgba(0,210,210,0.12)';ctx.lineWidth=2*Z;ctx.stroke();ctx.shadowBlur=0;
  }
  ctx.restore();

  // Weapon icon above head if holding non-melee
  if(player.weapon&&player.weapon.id!=='bat'){
    const sp=w2s(player.x,player.y,.8);
    ctx.font=`${14*Z}px serif`;ctx.textAlign='center';ctx.shadowBlur=6*Z;ctx.shadowColor=player.weapon.pCol;
    ctx.fillText(player.weapon.icon,sp.sx,sp.sy);ctx.shadowBlur=0;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MONSTER SPRITES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawMonster(m,Z){
  const p=iso(m.x,m.y,0);const sx=(p.sx-cam.x)*Z+cv.width/2,sy=(p.sy-cam.y)*Z+cv.height/2;
  if(sx<-100||sx>cv.width+100||sy<-100||sy>cv.height+100)return;
  const S=Z*m.type.sz*.82,ph=m.fr/4*Math.PI*2,mv=m.state==='chase',leg=mv?Math.sin(ph)*5:0;
  ctx.save();ctx.translate(sx,sy);
  ctx.beginPath();ctx.ellipse(0,4*S,9*S*m.type.sz,3.5*S,0,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.35)';ctx.fill();
  const n=m.type.name;
  if(n==='–ü–†–ò–ó–†–ê–ö'){
    ctx.globalAlpha=.72;ctx.fillStyle=m.type.col;ctx.beginPath();ctx.arc(0,-20*S,12*S,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.moveTo(-10*S,-10*S);for(let i=0;i<=6;i++)ctx.lineTo(-10*S+3.3*i*S,-10*S+Math.sin((i+m.fr)*.9)*4.5*S+9*S);ctx.lineTo(-10*S,-10*S);ctx.closePath();ctx.fill();ctx.globalAlpha=1;
    ctx.shadowBlur=10*Z;ctx.shadowColor=m.type.eyeCol;ctx.fillStyle=m.type.eyeCol;ctx.beginPath();ctx.arc(-4*S,-21*S,2.8*S,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(4*S,-21*S,2.8*S,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
  } else if(n==='–ì–û–õ–ï–ú'){
    ctx.fillStyle=m.type.col;ctx.beginPath();ctx.roundRect(-11*S,-30*S,22*S,28*S,2*S);ctx.fill();ctx.fillStyle=shade(m.type.col,-25);ctx.beginPath();ctx.roundRect(-9*S,-28*S,18*S,24*S,1*S);ctx.fill();
    ctx.strokeStyle='#00000044';ctx.lineWidth=1.5*S;ctx.beginPath();ctx.moveTo(-5*S,-24*S);ctx.lineTo(-1*S,-14*S);ctx.lineTo(-4*S,-7*S);ctx.stroke();
    ctx.fillStyle=shade(m.type.col,-18);ctx.beginPath();ctx.roundRect(-10*S,leg*S,9*S,10*S,1*S);ctx.fill();ctx.beginPath();ctx.roundRect(1*S,-leg*S,9*S,10*S,1*S);ctx.fill();
    ctx.fillStyle=m.type.col;ctx.beginPath();ctx.roundRect(-9*S,-44*S,18*S,16*S,4*S);ctx.fill();
    ctx.shadowBlur=12*Z;ctx.shadowColor=m.type.eyeCol;ctx.fillStyle=m.type.eyeCol;ctx.beginPath();ctx.arc(-4*S,-38*S,4.5*S,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(4*S,-38*S,4.5*S,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
  } else if(n==='–ó–û–ú–ë–ò'){
    ctx.fillStyle='#334433';ctx.beginPath();ctx.roundRect(-3.5*S,leg*S-2*S,6*S,12*S,2*S);ctx.fill();ctx.beginPath();ctx.roundRect(-7.5*S,-leg*S-2*S,6*S,12*S,2*S);ctx.fill();
    ctx.fillStyle=m.type.col;ctx.beginPath();ctx.roundRect(-8*S,-23*S,16*S,19*S,2*S);ctx.fill();
    ctx.fillStyle=shade(m.type.col,-18);ctx.save();ctx.translate(-10*S,-18*S);ctx.beginPath();ctx.roundRect(-2.5*S,-7*S,5*S,12*S,2*S);ctx.fill();ctx.restore();
    ctx.save();ctx.translate(10*S,-18*S);ctx.beginPath();ctx.roundRect(-2.5*S,leg*S,5*S,12*S,2*S);ctx.fill();ctx.restore();
    ctx.fillStyle='#b0c880';ctx.beginPath();ctx.arc(0,-31*S,7.5*S,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=9*Z;ctx.shadowColor=m.type.eyeCol;ctx.fillStyle=m.type.eyeCol;ctx.beginPath();ctx.arc(-3*S,-32*S,2.2*S,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(3*S,-32*S,2.2*S,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
  } else {
    ctx.fillStyle='#551111';ctx.beginPath();ctx.roundRect(-5*S,leg*S-2*S,8*S,14*S,2*S);ctx.fill();ctx.beginPath();ctx.roundRect(-9*S,-leg*S-2*S,8*S,14*S,2*S);ctx.fill();
    ctx.fillStyle=m.type.col;ctx.beginPath();ctx.roundRect(-10*S,-26*S,20*S,22*S,3*S);ctx.fill();
    ctx.fillStyle='#882222';for(const dx of[-1,1]){ctx.beginPath();ctx.moveTo(dx*8*S,-26*S);ctx.lineTo(dx*11*S,-35*S);ctx.lineTo(dx*5*S,-28*S);ctx.closePath();ctx.fill();}
    ctx.fillStyle=m.type.col;ctx.save();ctx.translate(-13*S,-18*S);ctx.beginPath();ctx.roundRect(-3*S,-leg*S,7*S,14*S,2*S);ctx.fill();ctx.restore();ctx.save();ctx.translate(13*S,-18*S);ctx.beginPath();ctx.roundRect(-3*S,leg*S,7*S,14*S,2*S);ctx.fill();ctx.restore();
    ctx.fillStyle='#cc5540';ctx.beginPath();ctx.arc(0,-35*S,8.5*S,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=12*Z;ctx.shadowColor=m.type.eyeCol;ctx.fillStyle=m.type.eyeCol;ctx.beginPath();ctx.arc(-3.5*S,-36*S,2.8*S,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(3.5*S,-36*S,2.8*S,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
  }
  // HP bar
  const hf=m.hp/m.type.maxHp;const bw=22*S,bx=-11*S,by=-56*S;
  ctx.fillStyle='#0a0a0a';ctx.fillRect(bx,by,bw,3.5*S);ctx.fillStyle=hf>.5?'#44dd44':hf>.25?'#ffaa00':'#ff3333';ctx.fillRect(bx,by,bw*hf,3.5*S);ctx.strokeStyle='#22222288';ctx.lineWidth=.5;ctx.strokeRect(bx,by,bw,3.5*S);
  ctx.font=`${7*Z}px Courier New`;ctx.textAlign='center';ctx.fillStyle=m.type.col;ctx.fillText(m.type.name,0,by-2.5*S);
  ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAR SPRITE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawCar(car,Z){
  const T=car.type,L=T.len,W=T.wid;
  function cp(lx,ly,lz=0){const co=Math.cos(car.angle),si=Math.sin(car.angle);const wx=car.x+lx*co-ly*si,wy=car.y+lx*si+ly*co;const p=iso(wx,wy,lz);return{sx:(p.sx-cam.x)*Z+cv.width/2,sy:(p.sy-cam.y)*Z+cv.height/2};}
  function cpoly(pts,fill,stk,lw=.5){ctx.beginPath();ctx.moveTo(pts[0].sx,pts[0].sy);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i].sx,pts[i].sy);ctx.closePath();if(fill){ctx.fillStyle=fill;ctx.fill();}if(stk){ctx.strokeStyle=stk;ctx.lineWidth=lw*Z;ctx.stroke();}}
  ctx.save();ctx.globalAlpha=.27;cpoly([cp(-W,-L),cp(W,-L),cp(W,L),cp(-W,L)],'#000',null);ctx.globalAlpha=1;ctx.restore();
  const BZ=.13,RZ=.29;
  for(const[lx,ly]of[[-W*.88,-L*.54],[W*.88,-L*.54],[-W*.88,L*.5],[W*.88,L*.5]]){const wc=cp(lx,ly,BZ*.25);ctx.beginPath();ctx.arc(wc.sx,wc.sy,3.5*Z,0,Math.PI*2);ctx.fillStyle='#101010';ctx.fill();ctx.strokeStyle='#3a3a3a';ctx.lineWidth=1.3*Z;ctx.stroke();ctx.beginPath();ctx.arc(wc.sx,wc.sy,1.5*Z,0,Math.PI*2);ctx.fillStyle='#666';ctx.fill();}
  cpoly([cp(-W,-L,0),cp(-W,-L,BZ),cp(-W,L,BZ),cp(-W,L,0)],shade(T.col2,-20),null);
  cpoly([cp(W,-L,0),cp(W,-L,BZ),cp(W,L,BZ),cp(W,L,0)],T.col2,null);
  cpoly([cp(-W,-L,0),cp(W,-L,0),cp(W,-L,BZ),cp(-W,-L,BZ)],shade(T.col,-15),null);
  cpoly([cp(-W,L,0),cp(W,L,0),cp(W,L,BZ),cp(-W,L,BZ)],shade(T.col,-30),null);
  cpoly([cp(-W,-L,BZ),cp(W,-L,BZ),cp(W,L,BZ),cp(-W,L,BZ)],T.col,'#00000055',.4);
  const CW=.7,CF=-L*.26,CR=L*.36;
  cpoly([cp(-W*CW,CF,BZ),cp(-W*CW,CF,RZ),cp(-W*CW,CR,RZ),cp(-W*CW,CR,BZ)],shade(T.col,-48),null);
  cpoly([cp(W*CW,CF,BZ),cp(W*CW,CF,RZ),cp(W*CW,CR,RZ),cp(W*CW,CR,BZ)],shade(T.col,-32),null);
  cpoly([cp(-W*CW,CF,BZ),cp(W*CW,CF,BZ),cp(W*CW,CF,RZ),cp(-W*CW,CF,RZ)],'rgba(110,180,255,.4)','#88ccff2a',.4);
  cpoly([cp(-W*CW,CR,BZ),cp(W*CW,CR,BZ),cp(W*CW,CR,RZ),cp(-W*CW,CR,RZ)],'rgba(80,140,200,.3)',null);
  cpoly([cp(-W*CW,CF,RZ),cp(W*CW,CF,RZ),cp(W*CW,CR,RZ),cp(-W*CW,CR,RZ)],shade(T.col,10),'#00000044',.4);
  const mv=Math.abs(car.spd)>.12||car.driven;
  for(const lx of[-W*.63,W*.63]){const hp=cp(lx,-L*.96,BZ*.65);ctx.beginPath();ctx.arc(hp.sx,hp.sy,3.2*Z,0,Math.PI*2);ctx.fillStyle=mv?'#ffffc0':'#888855';if(mv){ctx.shadowBlur=14*Z;ctx.shadowColor='#ffffaa';}ctx.fill();ctx.shadowBlur=0;}
  for(const lx of[-W*.68,W*.68]){const hp=cp(lx,L*.96,BZ*.58);ctx.beginPath();ctx.arc(hp.sx,hp.sy,2.8*Z,0,Math.PI*2);const brk=(car.driven&&bBrk)||car.spd<-.04;ctx.fillStyle=brk?'#ff2200':'#3a0000';if(brk){ctx.shadowBlur=9*Z;ctx.shadowColor='#ff2200';}ctx.fill();ctx.shadowBlur=0;}
  if(T.name==='–¢–∞–∫—Å–∏'){const tp=cp(0,CF*.5,RZ+.04);ctx.save();ctx.translate(tp.sx,tp.sy);ctx.fillStyle='#ffd700';ctx.font=`bold ${5*Z}px Courier New`;ctx.textAlign='center';ctx.fillText('–¢–ê–ö–°–ò',0,0);ctx.restore();}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MINIMAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawMinimap(){
  const MW=148,MH=108;mctx.fillStyle='#06060e';mctx.fillRect(0,0,MW,MH);
  const sx=MW/MAP_W,sy=MH/MAP_H;
  for(let y=0;y<MAP_H;y++)for(let x=0;x<MAP_W;x++){const t=map[y][x];mctx.fillStyle=t===T_ROAD||t===T_CROSS?'#22223a':t===T_PARK?'#152f18':'#0b0b16';mctx.fillRect(x*sx,y*sy,sx+.5,sy+.5);}
  for(const m of monsters){mctx.fillStyle=m.type.col;mctx.beginPath();mctx.arc(m.x*sx,m.y*sy,1.8,0,Math.PI*2);mctx.fill();}
  for(const c of cars){mctx.fillStyle=c.driven?'#ffd700':'#cc4444';mctx.fillRect(c.x*sx-1,c.y*sy-1,2.5,2.5);}
  for(const p of pickups){mctx.fillStyle=p.type.pCol||'#00ffff';mctx.beginPath();mctx.arc(p.x*sx,p.y*sy,2,0,Math.PI*2);mctx.fill();}
  mctx.fillStyle='#00ffff';mctx.beginPath();mctx.arc(player.x*sx,player.y*sy,3,0,Math.PI*2);mctx.fill();
  mctx.strokeStyle='#00ffff';mctx.lineWidth=1;mctx.beginPath();mctx.moveTo(player.x*sx,player.y*sy);mctx.lineTo((player.x+Math.cos(player.angle)*4)*sx,(player.y+Math.sin(player.angle)*4)*sy);mctx.stroke();
  mctx.strokeStyle='#00d4d433';mctx.lineWidth=1;mctx.strokeRect(0,0,MW,MH);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME LOOP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastT=0;
function loop(t){const dt=Math.min((t-lastT)/1e3,.05);lastT=t;update(dt);render();requestAnimationFrame(loop);}
requestAnimationFrame(loop);
</script>
</body>
</html>
